!======================================================================!
program oak
! Next save this with notes.
! Then look at geography or r-Pearson. DONE
! Then gradually add complexity to pet. DONE
! Then GPP and Su feedback, as simple as possible!
! Then stomata to control aet.
! Then growth, respiration, NPP.
!----------------------------------------------------------------------!
use params
use vars
!----------------------------------------------------------------------!
implicit none
!----------------------------------------------------------------------!
integer :: site_count
!----------------------------------------------------------------------!
open (10,file='/rds/user/adf10/rds-mb425-geogscratch/adf10/&
&TRENDYGCB2024/INPUT/global_co2_ann_1700_2023.txt',status='old')
do kyr_ce = 1700, 2023
  read (10,*) ikyr, co2_ppm (kyr_ce)
end do
close (10)
!----------------------------------------------------------------------!
if (nsites > 1) then
  filename = '/rds/user/adf10/rds-mb425-geogscratch/adf10/FORCINGS/ulf/&
              &clm_ulf_reg2_reorder.txt'
else
  filename = '/rds/user/adf10/rds-mb425-geogscratch/adf10/FORCINGS/&
             &ulf/clm_fon2.txt'
end if
!----------------------------------------------------------------------!
open (10, file = trim (filename), status = 'old')
!----------------------------------------------------------------------!
filename = 'output_ann.txt'
!----------------------------------------------------------------------!
open (20, file = trim (filename), status = 'unknown')
!----------------------------------------------------------------------!
filename = 'output_ann_sites.txt'
!----------------------------------------------------------------------!
open (21, file = trim (filename), status = 'unknown')
!----------------------------------------------------------------------!
GPP_ann_reg = zero
NPP_ann_reg = zero
!----------------------------------------------------------------------!
do ksite = 1, nsites
  !--------------------------------------------------------------------!
  read (10,*) ic, ikbox, lon, lat
  backspace (10)
  !--------------------------------------------------------------------!
  write (*,*) 'Running ksite = ', ksite, lon, lat
  !--------------------------------------------------------------------!
  larea = cosd (lat)
  tarea = tarea + larea
  !--------------------------------------------------------------------!
  call dayl
  !--------------------------------------------------------------------!
  sm = (SM_MIN + SM_MAX) / 2.0
  LAI = 1.0
  Abot = 100.0
  !--------------------------------------------------------------------!
  do kyr_ce = 1901, 2023
    !------------------------------------------------------------------!
    ca_fmol = co2_ppm (kyr_ce) / 1.0e6 ! mol[CO2] mol[air]-1
    !------------------------------------------------------------------!
    GPP_ann = zero
    NPP_ann = zero
    !------------------------------------------------------------------!
    AWG = .false.
    !------------------------------------------------------------------!
    Fstar = zero
    FG = .false.
    !------------------------------------------------------------------!
    do kday = 1, ndays
      !----------------------------------------------------------------!
      TC_day = zero
      !----------------------------------------------------------------!
      do kt = 1, nkt
        !--------------------------------------------------------------!
        read (10,*) ic, ikbox, lon, lat, kyr_clm, iit, &
                    tmp, pre, tswrf, dlwrf, spfh, pres, ugrd, vgrd
        !--------------------------------------------------------------!
        TC = tmp - tf
        TC_day = TC_day + TC
        !--------------------------------------------------------------!
        call crown
        !--------------------------------------------------------------!
        call hydro
        !--------------------------------------------------------------!
        call grow
        !--------------------------------------------------------------!
        if (FG) then
        GPP_ann = GPP_ann + dt * MC * Ag_crown ! g[C] m-2 yr-1
        NPP_ann = NPP_ann + dt * NPP           ! g[C] m-2 yr-1
        end if
        !--------------------------------------------------------------!
      end do ! kt
      !----------------------------------------------------------------!
      TC_day = TC_day / float (nkt)
      !----------------------------------------------------------------!
      call phen
if (FG) then
  LAI = 8.0 * sm / SM_MAX
!  if (Abot > 0.2e-6) then
!    LAI = LAI + 0.5
!  else
!    LAI = LAI - 0.1
!  end if
  LAI = min (7.0, LAI)
  !write (*,*) kday, Abot, LAI
else
  LAI = 1.0
end if
      !----------------------------------------------------------------!
    end do ! kday
    !------------------------------------------------------------------!
    if (nsites == 1) then
      ! output_ann.txt
      write (20,'(i5,2f12.4)') kyr_ce, GPP_ann, NPP_ann
    else
      GPP_ann_reg (kyr_ce) = GPP_ann_reg (kyr_ce) + larea * GPP_ann
      NPP_ann_reg (kyr_ce) = NPP_ann_reg (kyr_ce) + larea * NPP_ann
    end if
    !------------------------------------------------------------------!
    ! output_ann_sites.txt
    !------------------------------------------------------------------!
    write (21,'(2i5,3f12.4)') ksite, kyr_ce, lon, lat, GPP_ann!, NPP_ann
    !------------------------------------------------------------------!
  end do ! kyr_ce
  !--------------------------------------------------------------------!
end do ! ksite
!----------------------------------------------------------------------!
close (10)
close (21)
!----------------------------------------------------------------------!
if (nsites > 1) then
  GPP_ann_reg = GPP_ann_reg / tarea
  NPP_ann_reg = NPP_ann_reg / tarea
  do kyr_ce = 1901, 2023
    ! output_ann.txt
    write (20,'(i5,2f12.4)') kyr_ce, GPP_ann_reg (kyr_ce), &
                             NPP_ann_reg (kyr_ce)
  end do
end if
close (20)
!----------------------------------------------------------------------!
! For calibration.
!do kyr_ce = 1901, 2023
!  write (*,*) kyr_ce, AWG_s (kyr_ce)
!end do
!write (*,*) 'mean AWG_s', float (sum (AWG_s (2006:2014))) / &
!            (2014.0-2006.0+1.0)
!write (*,*) 'mean FG_s ', float (sum (FG_s  (2006:2014))) / &
!            (2014.0-2006.0+1.0)
!----------------------------------------------------------------------!
end program oak
!======================================================================!
